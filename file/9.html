<!DOCTYPE html >
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p9" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	-webkit-transform-origin: bottom left;
	-ms-transform-origin: bottom left;
	transform-origin: bottom left;
	-webkit-transform: scale(0.25);
	-ms-transform: scale(0.25);
	transform: scale(0.25);
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_9{left:101px;bottom:1085px;word-spacing:5.8px;}
#t2_9{left:83px;bottom:1070px;word-spacing:7.7px;}
#t3_9{left:83px;bottom:1055px;word-spacing:5.8px;}
#t4_9{left:83px;bottom:1039px;letter-spacing:-0.1px;word-spacing:1.5px;}
#t5_9{left:83px;bottom:1024px;letter-spacing:-0.1px;word-spacing:2.5px;}
#t6_9{left:83px;bottom:1009px;}
#t7_9{left:101px;bottom:994px;word-spacing:2.6px;}
#t8_9{left:83px;bottom:979px;word-spacing:4.3px;}
#t9_9{left:83px;bottom:963px;word-spacing:5.3px;}
#ta_9{left:83px;bottom:948px;word-spacing:9.3px;}
#tb_9{left:83px;bottom:933px;word-spacing:9.1px;}
#tc_9{left:83px;bottom:918px;word-spacing:3.1px;}
#td_9{left:83px;bottom:902px;letter-spacing:-0.1px;word-spacing:6.1px;}
#te_9{left:83px;bottom:887px;word-spacing:4.9px;}
#tf_9{left:83px;bottom:872px;letter-spacing:-0.1px;word-spacing:0.1px;}
#tg_9{left:83px;bottom:843px;}
#th_9{left:113px;bottom:843px;letter-spacing:-0.3px;word-spacing:0.7px;}
#ti_9{left:83px;bottom:822px;letter-spacing:-0.1px;word-spacing:4.8px;}
#tj_9{left:83px;bottom:807px;letter-spacing:-0.1px;word-spacing:5.4px;}
#tk_9{left:420px;bottom:807px;letter-spacing:-0.2px;}
#tl_9{left:83px;bottom:791px;letter-spacing:-0.1px;}
#tm_9{left:129px;bottom:791px;letter-spacing:-0.1px;word-spacing:4.4px;}
#tn_9{left:82px;bottom:776px;letter-spacing:-0.1px;word-spacing:-1.1px;}
#to_9{left:82px;bottom:761px;letter-spacing:-0.1px;word-spacing:2.3px;}
#tp_9{left:82px;bottom:746px;letter-spacing:-0.1px;word-spacing:5.2px;}
#tq_9{left:82px;bottom:730px;}
#tr_9{left:101px;bottom:715px;word-spacing:7.2px;}
#ts_9{left:83px;bottom:700px;word-spacing:6.1px;}
#tt_9{left:83px;bottom:685px;letter-spacing:-0.1px;word-spacing:12.6px;}
#tu_9{left:83px;bottom:670px;word-spacing:3.2px;}
#tv_9{left:83px;bottom:654px;word-spacing:12.5px;}
#tw_9{left:83px;bottom:639px;word-spacing:12.9px;}
#tx_9{left:83px;bottom:624px;word-spacing:6px;}
#ty_9{left:83px;bottom:609px;letter-spacing:-0.1px;word-spacing:4.3px;}
#tz_9{left:83px;bottom:593px;}
#t10_9{left:83px;bottom:578px;letter-spacing:-0.2px;word-spacing:0.3px;}
#t11_9{left:101px;bottom:563px;word-spacing:3.2px;}
#t12_9{left:83px;bottom:548px;letter-spacing:-0.1px;word-spacing:5.7px;}
#t13_9{left:83px;bottom:533px;word-spacing:-2.2px;}
#t14_9{left:83px;bottom:517px;letter-spacing:-0.2px;word-spacing:10px;}
#t15_9{left:83px;bottom:502px;letter-spacing:-0.1px;word-spacing:8.2px;}
#t16_9{left:83px;bottom:487px;word-spacing:6.1px;}
#t17_9{left:83px;bottom:472px;}
#t18_9{left:101px;bottom:456px;word-spacing:7.2px;}
#t19_9{left:83px;bottom:441px;word-spacing:5.2px;}
#t1a_9{left:83px;bottom:426px;word-spacing:6.3px;}
#t1b_9{left:83px;bottom:411px;letter-spacing:-0.1px;word-spacing:5.1px;}
#t1c_9{left:83px;bottom:396px;letter-spacing:-0.1px;word-spacing:0.2px;}
#t1d_9{left:83px;bottom:367px;}
#t1e_9{left:113px;bottom:367px;letter-spacing:-0.3px;word-spacing:0.7px;}
#t1f_9{left:83px;bottom:345px;word-spacing:-2.3px;}
#t1g_9{left:83px;bottom:330px;word-spacing:2.4px;}
#t1h_9{left:83px;bottom:315px;letter-spacing:-0.1px;word-spacing:4.2px;}
#t1i_9{left:83px;bottom:300px;letter-spacing:-0.1px;word-spacing:4.5px;}
#t1j_9{left:83px;bottom:284px;letter-spacing:-0.2px;word-spacing:0.3px;}
#t1k_9{left:101px;bottom:269px;word-spacing:-0.5px;}
#t1l_9{left:83px;bottom:254px;word-spacing:-0.9px;}
#t1m_9{left:83px;bottom:239px;word-spacing:4.3px;}
#t1n_9{left:83px;bottom:224px;word-spacing:5.9px;}
#t1o_9{left:83px;bottom:208px;word-spacing:4.9px;}
#t1p_9{left:83px;bottom:193px;letter-spacing:-0.1px;word-spacing:-1.8px;}
#t1q_9{left:83px;bottom:178px;letter-spacing:-0.1px;word-spacing:1.8px;}
#t1r_9{left:83px;bottom:163px;word-spacing:0.7px;}
#t1s_9{left:83px;bottom:147px;letter-spacing:-0.1px;word-spacing:3.6px;}
#t1t_9{left:83px;bottom:132px;word-spacing:3.3px;}
#t1u_9{left:83px;bottom:117px;letter-spacing:-0.1px;word-spacing:2.3px;}
#t1v_9{left:83px;bottom:102px;}
#t1w_9{left:503px;bottom:1085px;letter-spacing:-0.1px;word-spacing:9.8px;}
#t1x_9{left:484px;bottom:1070px;letter-spacing:-0.1px;word-spacing:7.1px;}
#t1y_9{left:484px;bottom:1055px;word-spacing:5.9px;}
#t1z_9{left:484px;bottom:1039px;word-spacing:7px;}
#t20_9{left:484px;bottom:1024px;letter-spacing:-0.1px;word-spacing:2.4px;}
#t21_9{left:484px;bottom:1009px;letter-spacing:-0.1px;word-spacing:-2.5px;}
#t22_9{left:484px;bottom:994px;word-spacing:3.3px;}
#t23_9{left:484px;bottom:979px;}
#t24_9{left:506px;bottom:979px;}
#t25_9{left:628px;bottom:979px;word-spacing:3px;}
#t26_9{left:790px;bottom:979px;}
#t27_9{left:820px;bottom:979px;word-spacing:2.9px;}
#t28_9{left:484px;bottom:963px;letter-spacing:-0.1px;word-spacing:-1px;}
#t29_9{left:484px;bottom:948px;word-spacing:3.2px;}
#t2a_9{left:484px;bottom:933px;word-spacing:2.9px;}
#t2b_9{left:484px;bottom:918px;word-spacing:3.9px;}
#t2c_9{left:484px;bottom:902px;letter-spacing:-0.1px;word-spacing:0.2px;}
#t2d_9{left:503px;bottom:887px;word-spacing:-0.3px;}
#t2e_9{left:484px;bottom:872px;letter-spacing:-0.1px;word-spacing:-1.7px;}
#t2f_9{left:484px;bottom:857px;letter-spacing:-0.2px;word-spacing:0.4px;}
#t2g_9{left:503px;bottom:842px;letter-spacing:-0.1px;word-spacing:3.1px;}
#t2h_9{left:484px;bottom:826px;letter-spacing:-0.2px;word-spacing:3.8px;}
#t2i_9{left:607px;bottom:826px;}
#t2j_9{left:679px;bottom:826px;word-spacing:3.5px;}
#t2k_9{left:484px;bottom:811px;}
#t2l_9{left:503px;bottom:796px;word-spacing:9.8px;}
#t2m_9{left:484px;bottom:781px;word-spacing:10.8px;}
#t2n_9{left:659px;bottom:781px;}
#t2o_9{left:715px;bottom:781px;word-spacing:10.7px;}
#t2p_9{left:484px;bottom:765px;letter-spacing:-0.1px;word-spacing:-1.4px;}
#t2q_9{left:484px;bottom:750px;}
#t2r_9{left:503px;bottom:735px;letter-spacing:-0.1px;word-spacing:11.9px;}
#t2s_9{left:484px;bottom:720px;letter-spacing:-0.1px;word-spacing:0.4px;}
#t2t_9{left:484px;bottom:705px;letter-spacing:-0.1px;word-spacing:0.1px;}
#t2u_9{left:503px;bottom:689px;letter-spacing:-0.1px;word-spacing:10.4px;}
#t2v_9{left:484px;bottom:674px;word-spacing:8.7px;}
#t2w_9{left:484px;bottom:659px;letter-spacing:-0.1px;word-spacing:10.3px;}
#t2x_9{left:484px;bottom:644px;word-spacing:6.8px;}
#t2y_9{left:484px;bottom:628px;letter-spacing:-0.1px;word-spacing:11.5px;}
#t2z_9{left:484px;bottom:613px;letter-spacing:-0.1px;word-spacing:1.9px;}
#t30_9{left:484px;bottom:598px;letter-spacing:-0.2px;word-spacing:0.4px;}
#t31_9{left:503px;bottom:583px;letter-spacing:-0.1px;word-spacing:-0.1px;}
#t32_9{left:484px;bottom:568px;word-spacing:3.4px;}
#t33_9{left:484px;bottom:552px;word-spacing:-3.1px;}
#t34_9{left:484px;bottom:537px;letter-spacing:-0.1px;}
#t35_9{left:484px;bottom:522px;letter-spacing:-0.1px;word-spacing:-0.7px;}
#t36_9{left:484px;bottom:507px;letter-spacing:-0.1px;word-spacing:0.2px;}
#t37_9{left:484px;bottom:491px;letter-spacing:-0.1px;word-spacing:2.2px;}
#t38_9{left:484px;bottom:476px;letter-spacing:-0.3px;word-spacing:2.6px;}
#t39_9{left:484px;bottom:461px;}
#t3a_9{left:503px;bottom:446px;word-spacing:1.1px;}
#t3b_9{left:484px;bottom:431px;word-spacing:0.4px;}
#t3c_9{left:484px;bottom:415px;word-spacing:0.5px;}
#t3d_9{left:484px;bottom:400px;letter-spacing:-0.1px;word-spacing:0.2px;}
#t3e_9{left:484px;bottom:351px;}
#t3f_9{left:515px;bottom:351px;letter-spacing:-0.1px;}
#t3g_9{left:484px;bottom:330px;letter-spacing:-0.1px;word-spacing:-1.2px;}
#t3h_9{left:484px;bottom:315px;letter-spacing:-0.1px;word-spacing:10.7px;}
#t3i_9{left:484px;bottom:300px;}
#t3j_9{left:503px;bottom:284px;letter-spacing:-0.1px;word-spacing:1.4px;}
#t3k_9{left:484px;bottom:269px;letter-spacing:-0.1px;word-spacing:6.2px;}
#t3l_9{left:484px;bottom:254px;letter-spacing:-0.1px;}
#t3m_9{left:484px;bottom:239px;letter-spacing:-0.2px;word-spacing:5.4px;}
#t3n_9{left:484px;bottom:224px;word-spacing:4.3px;}
#t3o_9{left:484px;bottom:208px;word-spacing:-0.7px;}
#t3p_9{left:484px;bottom:193px;}
#t3q_9{left:503px;bottom:178px;letter-spacing:-0.2px;word-spacing:8px;}
#t3r_9{left:484px;bottom:163px;word-spacing:6.1px;}
#t3s_9{left:484px;bottom:147px;word-spacing:9px;}
#t3t_9{left:484px;bottom:132px;letter-spacing:-0.1px;word-spacing:8.1px;}
#t3u_9{left:484px;bottom:117px;letter-spacing:-0.2px;word-spacing:0.7px;}
#t3v_9{left:484px;bottom:102px;word-spacing:-2.6px;}

.s1_9{
	FONT-SIZE: 54.8px;
	FONT-FAMILY: NimbusRomNo9L-Regu_9;
	color: rgb(0,0,0);
}

.s2_9{
	FONT-SIZE: 54.8px;
	FONT-FAMILY: NimbusRomNo9L-Medi_6;
	color: rgb(0,0,0);
}

.s3_9{
	FONT-SIZE: 54.8px;
	FONT-FAMILY: NimbusRomNo9L-ReguItal_x;
	color: rgb(0,0,0);
}

.s4_9{
	FONT-SIZE: 54.8px;
	FONT-FAMILY: CMTT9_o;
	color: rgb(0,0,0);
}

</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts9" type="text/css" >

@font-face {
	font-family: CMTT9_o;
	src: url("fonts/CMTT9_o.woff") format("woff");
}

@font-face {
	font-family: NimbusRomNo9L-Medi_6;
	src: url("fonts/NimbusRomNo9L-Medi_6.woff") format("woff");
}

@font-face {
	font-family: NimbusRomNo9L-ReguItal_x;
	src: url("fonts/NimbusRomNo9L-ReguItal_x.woff") format("woff");
}

@font-face {
	font-family: NimbusRomNo9L-Regu_9;
	src: url("fonts/NimbusRomNo9L-Regu_9.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg9Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg9" style="-webkit-user-select: none;"><object width="935" height="1210" data="9/9.svg" type="image/svg+xml" id="pdf9" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div id="t1_9" class="t s1_9">When a trace call returns, the monitor restores the interpreter</div>
<div id="t2_9" class="t s1_9">state. First, the monitor checks the reason for the trace exit and</div>
<div id="t3_9" class="t s1_9">applies blacklisting if needed. Then, it pops or synthesizes inter-</div>
<div id="t4_9" class="t s1_9">preter JavaScript call stack frames as needed. Finally, it copies the</div>
<div id="t5_9" class="t s1_9">imported variables back from the trace activation record to the in-</div>
<div id="t6_9" class="t s1_9">terpreter state.</div>
<div id="t7_9" class="t s1_9">At least in the current implementation, these steps have a non-</div>
<div id="t8_9" class="t s1_9">negligible runtime cost, so minimizing the number of interpreter-</div>
<div id="t9_9" class="t s1_9">to-trace and trace-to-interpreter transitions is essential for perfor-</div>
<div id="ta_9" class="t s1_9">mance. (see also Section 3.3). Our experiments (see Figure 12)</div>
<div id="tb_9" class="t s1_9">show that for programs we can trace well such transitions hap-</div>
<div id="tc_9" class="t s1_9">pen infrequently and hence do not contribute signiﬁcantly to total</div>
<div id="td_9" class="t s1_9">runtime. In a few programs, where the system is prevented from</div>
<div id="te_9" class="t s1_9">recording branch traces for hot side exits by aborts, this cost can</div>
<div id="tf_9" class="t s1_9">rise to up to 10% of total execution time.</div>
<div id="tg_9" class="t s2_9">6.2</div>
<div id="th_9" class="t s2_9">Trace Stitching</div>
<div id="ti_9" class="t s1_9">Transitions from a trace to a branch trace at a side exit avoid the</div>
<div id="tj_9" class="t s1_9">costs of calling traces from the monitor, in a feature called</div>
<div id="tk_9" class="t s3_9">trace</div>
<div id="tl_9" class="t s3_9">stitching</div>
<div id="tm_9" class="t s1_9">. At a side exit, the exiting trace only needs to write live</div>
<div id="tn_9" class="t s1_9">register-carried values back to its trace activation record. In our im-</div>
<div id="to_9" class="t s1_9">plementation, identical type maps yield identical activation record</div>
<div id="tp_9" class="t s1_9">layouts, so the trace activation record can be reused immediately</div>
<div id="tq_9" class="t s1_9">by the branch trace.</div>
<div id="tr_9" class="t s1_9">In programs with branchy trace trees with small traces, trace</div>
<div id="ts_9" class="t s1_9">stitching has a noticeable cost. Although writing to memory and</div>
<div id="tt_9" class="t s1_9">then soon reading back would be expected to have a high L1</div>
<div id="tu_9" class="t s1_9">cache hit rate, for small traces the increased instruction count has</div>
<div id="tv_9" class="t s1_9">a noticeable cost. Also, if the writes and reads are very close</div>
<div id="tw_9" class="t s1_9">in the dynamic instruction stream, we have found that current</div>
<div id="tx_9" class="t s1_9">x86 processors often incur penalties of 6 cycles or more (e.g., if</div>
<div id="ty_9" class="t s1_9">the instructions use different base registers with equal values, the</div>
<div id="tz_9" class="t s1_9">processor may not be able to detect that the addresses are the same</div>
<div id="t10_9" class="t s1_9">right away).</div>
<div id="t11_9" class="t s1_9">The alternate solution is to recompile an entire trace tree, thus</div>
<div id="t12_9" class="t s1_9">achieving inter-trace register allocation (10). The disadvantage is</div>
<div id="t13_9" class="t s1_9">that tree recompilation takes time quadratic in the number of traces.</div>
<div id="t14_9" class="t s1_9">We believe that the cost of recompiling a trace tree every time</div>
<div id="t15_9" class="t s1_9">a branch is added would be prohibitive. That problem might be</div>
<div id="t16_9" class="t s1_9">mitigated by recompiling only at certain points, or only for very</div>
<div id="t17_9" class="t s1_9">hot, stable trees.</div>
<div id="t18_9" class="t s1_9">In the future, multicore hardware is expected to be common,</div>
<div id="t19_9" class="t s1_9">making background tree recompilation attractive. In a closely re-</div>
<div id="t1a_9" class="t s1_9">lated project (13) background recompilation yielded speedups of</div>
<div id="t1b_9" class="t s1_9">up to 1.25x on benchmarks with many branch traces. We plan to</div>
<div id="t1c_9" class="t s1_9">apply this technique to TraceMonkey as future work.</div>
<div id="t1d_9" class="t s2_9">6.3</div>
<div id="t1e_9" class="t s2_9">Trace Recording</div>
<div id="t1f_9" class="t s1_9">The job of the trace recorder is to emit LIR with identical semantics</div>
<div id="t1g_9" class="t s1_9">to the currently running interpreter bytecode trace. A good imple-</div>
<div id="t1h_9" class="t s1_9">mentation should have low impact on non-tracing interpreter per-</div>
<div id="t1i_9" class="t s1_9">formance and a convenient way for implementers to maintain se-</div>
<div id="t1j_9" class="t s1_9">mantic equivalence.</div>
<div id="t1k_9" class="t s1_9">In our implementation, the only direct modiﬁcation to the inter-</div>
<div id="t1l_9" class="t s1_9">preter is a call to the trace monitor at loop edges. In our benchmark</div>
<div id="t1m_9" class="t s1_9">results (see Figure 12) the total time spent in the monitor (for all</div>
<div id="t1n_9" class="t s1_9">activities) is usually less than 5%, so we consider the interpreter</div>
<div id="t1o_9" class="t s1_9">impact requirement met. Incrementing the loop hit counter is ex-</div>
<div id="t1p_9" class="t s1_9">pensive because it requires us to look up the loop in the trace cache,</div>
<div id="t1q_9" class="t s1_9">but we have tuned our loops to become hot and trace very quickly</div>
<div id="t1r_9" class="t s1_9">(on the second iteration). The hit counter implementation could be</div>
<div id="t1s_9" class="t s1_9">improved, which might give us a small increase in overall perfor-</div>
<div id="t1t_9" class="t s1_9">mance, as well as more ﬂexibility with tuning hotness thresholds.</div>
<div id="t1u_9" class="t s1_9">Once a loop is blacklisted we never call into the trace monitor for</div>
<div id="t1v_9" class="t s1_9">that loop (see Section 3.3).</div>
<div id="t1w_9" class="t s1_9">Recording is activated by a pointer swap that sets the inter-</div>
<div id="t1x_9" class="t s1_9">preter’s dispatch table to call a single “interrupt” routine for ev-</div>
<div id="t1y_9" class="t s1_9">ery bytecode. The interrupt routine ﬁrst calls a bytecode-speciﬁc</div>
<div id="t1z_9" class="t s1_9">recording routine. Then, it turns off recording if necessary (e.g.,</div>
<div id="t20_9" class="t s1_9">the trace ended). Finally, it jumps to the standard interpreter byte-</div>
<div id="t21_9" class="t s1_9">code implementation. Some bytecodes have effects on the type map</div>
<div id="t22_9" class="t s1_9">that cannot be predicted before executing the bytecode (e.g., call-</div>
<div id="t23_9" class="t s1_9">ing</div>
<div id="t24_9" class="t s4_9">String.charCodeAt</div>
<div id="t25_9" class="t s1_9">, which returns an integer or</div>
<div id="t26_9" class="t s3_9">NaN</div>
<div id="t27_9" class="t s1_9">if the</div>
<div id="t28_9" class="t s1_9">index argument is out of range). For these, we arrange for the inter-</div>
<div id="t29_9" class="t s1_9">preter to call into the recorder again after executing the bytecode.</div>
<div id="t2a_9" class="t s1_9">Since such hooks are relatively rare, we embed them directly into</div>
<div id="t2b_9" class="t s1_9">the interpreter, with an additional runtime check to see whether a</div>
<div id="t2c_9" class="t s1_9">recorder is currently active.</div>
<div id="t2d_9" class="t s1_9">While separating the interpreter from the recorder reduces indi-</div>
<div id="t2e_9" class="t s1_9">vidual code complexity, it also requires careful implementation and</div>
<div id="t2f_9" class="t s1_9">extensive testing to achieve semantic equivalence.</div>
<div id="t2g_9" class="t s1_9">In some cases achieving this equivalence is difﬁcult since Spi-</div>
<div id="t2h_9" class="t s1_9">derMonkey follows a</div>
<div id="t2i_9" class="t s3_9">fat-bytecode</div>
<div id="t2j_9" class="t s1_9">design, which was found to be</div>
<div id="t2k_9" class="t s1_9">beneﬁcial to pure interpreter performance.</div>
<div id="t2l_9" class="t s1_9">In fat-bytecode designs, individual bytecodes can implement</div>
<div id="t2m_9" class="t s1_9">complex processing (e.g., the</div>
<div id="t2n_9" class="t s4_9">getprop</div>
<div id="t2o_9" class="t s1_9">bytecode, which imple-</div>
<div id="t2p_9" class="t s1_9">ments full JavaScript property value access, including special cases</div>
<div id="t2q_9" class="t s1_9">for cached and dense array access).</div>
<div id="t2r_9" class="t s1_9">Fat bytecodes have two advantages: fewer bytecodes means</div>
<div id="t2s_9" class="t s1_9">lower dispatch cost, and bigger bytecode implementations give the</div>
<div id="t2t_9" class="t s1_9">compiler more opportunities to optimize the interpreter.</div>
<div id="t2u_9" class="t s1_9">Fat bytecodes are a problem for TraceMonkey because they</div>
<div id="t2v_9" class="t s1_9">require the recorder to reimplement the same special case logic</div>
<div id="t2w_9" class="t s1_9">in the same way. Also, the advantages are reduced because (a)</div>
<div id="t2x_9" class="t s1_9">dispatch costs are eliminated entirely in compiled traces, (b) the</div>
<div id="t2y_9" class="t s1_9">traces contain only one special case, not the interpreter’s large</div>
<div id="t2z_9" class="t s1_9">chunk of code, and (c) TraceMonkey spends less time running the</div>
<div id="t30_9" class="t s1_9">base interpreter.</div>
<div id="t31_9" class="t s1_9">One way we have mitigated these problems is by implementing</div>
<div id="t32_9" class="t s1_9">certain complex bytecodes in the recorder as sequences of simple</div>
<div id="t33_9" class="t s1_9">bytecodes. Expressing the original semantics this way is not too dif-</div>
<div id="t34_9" class="t s1_9">ﬁcult, and recording simple bytecodes is much easier. This enables</div>
<div id="t35_9" class="t s1_9">us to retain the advantages of fat bytecodes while avoiding some of</div>
<div id="t36_9" class="t s1_9">their problems for trace recording. This is particularly effective for</div>
<div id="t37_9" class="t s1_9">fat bytecodes that recurse back into the interpreter, for example to</div>
<div id="t38_9" class="t s1_9">convert an object into a primitive value by invoking a well-known</div>
<div id="t39_9" class="t s1_9">method on the object, since it lets us inline this function call.</div>
<div id="t3a_9" class="t s1_9">It is important to note that we split fat opcodes into thinner op-</div>
<div id="t3b_9" class="t s1_9">codes only during recording. When running purely interpretatively</div>
<div id="t3c_9" class="t s1_9">(i.e. code that has been blacklisted), the interpreter directly and ef-</div>
<div id="t3d_9" class="t s1_9">ﬁciently executes the fat opcodes.</div>
<div id="t3e_9" class="t s2_9">6.4</div>
<div id="t3f_9" class="t s2_9">Preemption</div>
<div id="t3g_9" class="t s1_9">SpiderMonkey, like many VMs, needs to preempt the user program</div>
<div id="t3h_9" class="t s1_9">periodically. The main reasons are to prevent inﬁnitely looping</div>
<div id="t3i_9" class="t s1_9">scripts from locking up the host system and to schedule GC.</div>
<div id="t3j_9" class="t s1_9">In the interpreter, this had been implemented by setting a “pre-</div>
<div id="t3k_9" class="t s1_9">empt now” ﬂag that was checked on every backward jump. This</div>
<div id="t3l_9" class="t s1_9">strategy carried over into TraceMonkey: the VM inserts a guard on</div>
<div id="t3m_9" class="t s1_9">the preemption ﬂag at every loop edge. We measured less than a</div>
<div id="t3n_9" class="t s1_9">1% increase in runtime on most benchmarks for this extra guard.</div>
<div id="t3o_9" class="t s1_9">In practice, the cost is detectable only for programs with very short</div>
<div id="t3p_9" class="t s1_9">loops.</div>
<div id="t3q_9" class="t s1_9">We tested and rejected a solution that avoided the guards by</div>
<div id="t3r_9" class="t s1_9">compiling the loop edge as an unconditional jump, and patching</div>
<div id="t3s_9" class="t s1_9">the jump target to an exit routine when preemption is required.</div>
<div id="t3t_9" class="t s1_9">This solution can make the normal case slightly faster, but then</div>
<div id="t3u_9" class="t s1_9">preemption becomes very slow. The implementation was also very</div>
<div id="t3v_9" class="t s1_9">complex, especially trying to restart execution after the preemption.</div>

<!-- End text definitions -->


</div>
</body>
</html>
